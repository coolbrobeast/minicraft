<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JS Minecraft - Multiplayer Fixed</title>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// ---- YOUR FIREBASE CONFIG ----
const firebaseConfig = {
  apiKey: "AIzaSyBPGf2VzQ8cxynG___OmdyA7JtIq7i9jxU",
  authDomain: "minicraft-50b06.firebaseapp.com",
  projectId: "minicraft-50b06",
  storageBucket: "minicraft-50b06.appspot.com",
  messagingSenderId: "680126695366",
  appId: "1:680126695366:web:56949be03a1e1dcec994c7",
  measurementId: "G-42HKEQPMMQ"
};
const appId = "minecraft-v2";

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let user = null;
let username = "Player";
let isJoined = false;

// DOM elements
const instructions = document.getElementById('instructions');
const startBtn = document.getElementById('start-btn');
const usernameInput = document.getElementById('username-input');

// ---- AUTH FUNCTION ----
async function initAuth() {
    await signInAnonymously(auth);
}

onAuthStateChanged(auth, (u) => {
    user = u;
    if (user) console.log("Logged in as:", user.uid);
});

// ---- SYNC FUNCTION ----
async function syncSelf() {
    if (!user) return;
    const playerRef = doc(db, 'artifacts', appId, 'public', 'data', 'players', user.uid);
    await setDoc(playerRef, { username, lastSeen: Date.now() }, { merge: true });
}

// ---- FIXED JOIN BUTTON ----
startBtn.addEventListener('click', async () => {
    if (usernameInput.value.trim()) username = usernameInput.value.trim();

    startBtn.disabled = true;
    startBtn.innerText = "Joining...";

    try {
        await initAuth();
        await syncSelf();

        isJoined = true;
        instructions.style.display = 'none';
        console.log("Joined world successfully!");
    } catch (err) {
        console.error("Failed to join:", err);
        startBtn.disabled = false;
        startBtn.innerText = "JOIN WORLD";
        alert("Failed to join world. Check console.");
    }
});
</script>
</head>
<body>
<div id="instructions">
    <div id="username-prompt">
        <h2>Character Setup</h2>
        <input type="text" id="username-input" placeholder="Player Name..." maxlength="15">
        <button id="start-btn">JOIN WORLD</button>
    </div>
</div>
</body>
</html>
